---
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
    css: "ReportDashboardStyles.css"
editor_options: 
  chunk_output_type: console
---

Firms {data-navmenu="Firm Synthesis Model"}
============================================

Highlights {data-width=150}
--------------------------------------------

**Firm Synthesis Model: Firms in the Model Region**

Firm synthesis model outputs enumerating firms by size, location, and industry.

### Synthesized Firms City of Chicago

```{r Synthesized_Firms_ValueBox_Chicago}
value <- format(ScenarioFirms[TAZ %in% BASE_TAZ_CHICAGO, .N], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Firms<br>City of Chicago</br>", icon = "fa-building-o")
```

### Synthesized Firms Cook County Outside Chicago

```{r Synthesized_Firms_ValueBox_Cook_Not_Chicago}
value <- format(ScenarioFirms[TAZ %in% BASE_TAZ_COOK & !TAZ %in% BASE_TAZ_CHICAGO, .N], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Firms<br>Cook County (Not Chicago)</br>", icon = "fa-building-o")
```

### Synthesized Firms Rest of CMAP MPO Area (Not Cook County)

```{r Synthesized_Firms_ValueBox_CMAP_MPO}
value <- format(ScenarioFirms[TAZ %in% BASE_TAZ_CMAP & !TAZ %in% BASE_TAZ_COOK, .N], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Firms<br>Rest of CMAP MPO Area (Not Cook County)</br>", icon = "fa-building-o")
```

### Synthesized Firms Rest of Region

```{r Synthesized_Firms_ValueBox_Rest_Region}
value <- format(ScenarioFirms[!TAZ %in% BASE_TAZ_CMAP, .N], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Firms<br>Rest of Model Region</br>", icon = "fa-building-o")
```

### Synthesized Firms Model Region

```{r Synthesized_Firms_ValueBox_ALL}
value <- format(ScenarioFirms[, .N], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Firms<br>Model Region</br>", icon = "fa-building-o")
```

Column {data-width=400 .tabset}
--------------------------------------------
### Firms by Industry

```{r Map_Firms_By_Industry}
k <- 25
map <- leaflet(width = "100%") %>%
  addProviderTiles(map_type, group = "Background Map")
map <- map %>% addTAZPoints(data = ScenarioFirms, shp = shp,
                            group = "EmpCatGroupedName",
                            scale.factor = k) %>%
  addTAZPolygons() %>%
  addPolygons(data = shp, weight = 0.5,
              opacity = 0.25, color = "grey",
              fillOpacity = 0, fillColor = "white") %>%
  addEasyButton(easyButton(
    icon = "ion-arrow-shrink",
    title = "Reset View",
    onClick = JS("function(btn, map){
                 map.setView(map._initialCenter, map._initialZoom);}"))) %>%
  htmlwidgets::onRender(JS("function(el, x){
  var map = this;
  map.whenReady(function(){
    map._initialCenter = map.getCenter();
    map._initialZoom = map.getZoom();
  });
  }"))
map %>% htmlwidgets::onRender(JS(paste0("function(el, x){
var map = this;
var corner1 = new L.LatLng(",CMAP_BBOX["y", "min"],", ",CMAP_BBOX["x", "min"],"),
    corner2 = new L.LatLng(",CMAP_BBOX["y", "max"],", ",CMAP_BBOX["x", "max"],"),
    bounds = new L.LatLngBounds(corner1, corner2);
map.fitBounds(bounds);
}")))
```

>`r if(SCENARIO_RUN_FIRMSYN) {paste0("Note: Each data point represents ", comma(k), " firms within model region and precise locations are illustrative as firms are only identified geographically at the TAZ-level.")}`

### Firms by Size

```{r Map_Firms_By_Size}
k <- 25
map <- leaflet(shp, width = "100%") %>%
  addProviderTiles(map_type, group = "Background Map")
map <- map %>% addTAZPoints(data = ScenarioFirms, shp = shp,
                            group = "esizecat", scale.factor = k) %>%
  addTAZPolygons() %>%
  addPolygons(data = shp, weight = 0.5,
              opacity = 0.25, color = "grey",
              fillOpacity = 0, fillColor = "white") %>%
  addEasyButton(easyButton(
    icon = "ion-arrow-shrink",
    title = "Reset View",
    onClick = JS("function(btn, map){
                 map.setView(map._initialCenter, map._initialZoom);}"))) %>%
  htmlwidgets::onRender(JS("function(el, x){
  var map = this;
  map.whenReady(function(){
    map._initialCenter = map.getCenter();
    map._initialZoom = map.getZoom();
  });
  }"))
map %>% htmlwidgets::onRender(JS(paste0("function(el, x){
var map = this;
var corner1 = new L.LatLng(",CMAP_BBOX["y", "min"],", ",CMAP_BBOX["x", "min"],"),
    corner2 = new L.LatLng(",CMAP_BBOX["y", "max"],", ",CMAP_BBOX["x", "max"],"),
    bounds = new L.LatLngBounds(corner1, corner2);
map.fitBounds(bounds);
}")))
```

>`r if(SCENARIO_DB_FIRMSYN) {paste0("Note: Each data point represents ", comma(k), " firms within model region and precise locations are illustrative as firms are only identified geographically at the TAZ-level.")}`

Column {data-width=400 .tabset}
--------------------------------------------

### Firms by Industry

```{r Chart_Firms_By_Industry}
# Organize
dat <- ScenarioFirms[, .N, keyby = .(Region = TAZ_TYPE, Industry = EmpCatGroupedName)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Firms_by_Industry.csv"))
assign("db_tab_firms_industry", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Industry", yvar = "N", ylabel = "Firms",
                        fill = "Region", position = "dodge", coord_flip = TRUE)
```

### Firms by Size

```{r Chart_Firms_By_Size}
# Organize
dat <- ScenarioFirms[, .N, keyby = .(Region = TAZ_TYPE, Size = esizecat)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Firms_by_Size.csv"))
assign("db_tab_firms_size", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Size", yvar = "N", xlabel = "Firm Size Category", ylabel = "Firms", fill = "Region", position = "dodge", coord_flip = TRUE)
```

### Firms by District

```{r Chart_Firms_By_District}
# Organize
dat <- ScenarioFirms[, .N, keyby = .(Region)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Firms_by_District.csv"))
assign("db_tab_firms_district", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Region", yvar = "N", xlabel = "District", ylabel = "Firms", 
             coord_flip = TRUE)
```

### Firms by Industry and Size (CMAP)

```{r Chart_Firms_By_Industry_And_Size_CMAP}
# Organize
dat <- ScenarioFirms[TAZ_TYPE=="CMAP MPO Area", .N, keyby = .(Industry = EmpCatGroupedName, Size = esizecat)]

dat <- add_totals(dcast.data.table(dat,
                     Industry ~ Size,
                     fun.aggregate = sum,
                     value.var = "N"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Firms_by_Industry_and_Size_CMAP.csv"))
assign("db_tab_firms_industry_size_cmap", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")


```

> Includes firms within the CMAP MPO area only

### Firms by Industry and Size (Rest of Model Region)

```{r Chart_Firms_By_Industry_And_Size_Rest_Region}
# Organize
dat <- ScenarioFirms[TAZ_TYPE=="Non-CMAP Part of Model Region", .N, keyby = .(Industry = EmpCatGroupedName, Size = esizecat)]

dat <- add_totals(dcast.data.table(dat,
                     Industry ~ Size,
                     fun.aggregate = sum,
                     value.var = "N"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Firms_by_Industry_and_Size_Rest_Region.csv"))
assign("db_tab_firms_industry_size_rest_region", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")


```

> Includes firms within the rest of the model region only

### Firms by Industry and District

```{r Chart_Firms_By_Industry_And_District}
# Organize
dat <- ScenarioFirms[, .N, keyby = .(Industry = EmpCatGroupedName, Region)]

dat <- add_totals(dcast.data.table(dat,
                     Industry ~ Region,
                     fun.aggregate = sum,
                     value.var = "N"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Firms_by_Industry_and_District.csv"))
assign("db_tab_firms_industry_district", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")


```

> Includes firms within the whole model region.

Employment {data-navmenu="Firm Synthesis Model"}
============================================

Highlights {data-width=100}
--------------------------------------------

**Firm Synthesis Model: Employment in the Model Region**

Firm synthesis model outputs enumerating employment by location and industry.

### Synthesized Employment (Chicago)

```{r}
value <- format(ScenarioFirms[TAZ %in% BASE_TAZ_CHICAGO, sum(Employees)], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Employees<br>City of Chicago</br>", icon = "fa-briefcase")
```

### Synthesized Firms Cook County Outside Chicago

```{r}
value <- format(ScenarioFirms[TAZ %in% BASE_TAZ_COOK & !TAZ %in% BASE_TAZ_CHICAGO, sum(Employees)], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Employees<br>Cook County (Not Chicago)</br>", icon = "fa-briefcase")
```

### Synthesized Employment Rest of CMAP MPO Area (Not Cook County)

```{r}
value <- format(ScenarioFirms[TAZ %in% BASE_TAZ_CMAP & !TAZ %in% BASE_TAZ_COOK, sum(Employees)], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Employees<br>Rest of CMAP MPO Area (Not Cook County)</br>", icon = "fa-briefcase")
```

### Synthesized Employment (Rest of Model Region)

```{r}
value <- format(ScenarioFirms[TAZ_TYPE=="Non-CMAP Part of Model Region", sum(Employees)], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Employees<br>Non-CMAP Region</br>", 
         icon = "fa-briefcase")
```

### Synthesized Employment TOTAL

```{r}
value <- format(ScenarioFirms[, sum(Employees)], big.mark = ",", trim = TRUE)
valueBox(value, caption = "Synthesized Employees<br>Total</br>", icon = "fa-briefcase")
```

Column {data-width=400 .tabset}
--------------------------------------------

### Employment by Industry

```{r Map_Employment_By_Industry}
k <- 50
map <- leaflet(shp, width = "100%") %>%
  addProviderTiles(map_type, group = "Background Map")
map <- map %>% addTAZPoints(data = ScenarioFirms, shp = shp,
                            group = "EmpCatGroupedName", weight = "Employees",
                            scale.factor = k) %>%
  addPolygons(data = shp, weight = 0.5,
              opacity = 0.25, color = "grey",
              fillOpacity = 0, fillColor = "white") %>%
  addTAZPolygons()
map %>% htmlwidgets::onRender(JS(paste0("function(el, x){
var map = this;
var corner1 = new L.LatLng(",CMAP_BBOX["y", "min"],", ",CMAP_BBOX["x", "min"],"),
    corner2 = new L.LatLng(",CMAP_BBOX["y", "max"],", ",CMAP_BBOX["x", "max"],"),
    bounds = new L.LatLngBounds(corner1, corner2);
map.fitBounds(bounds);
}")))
```

>`r if(SCENARIO_DB_FIRMSYN) {paste0("Note: Each data point represents ", comma(k), " employees and precise locations are illustrative as firms are only identified geographically at the TAZ-level.")}`

### Employment by Size

```{r Map_Employment_By_Size}
k <- 25
map <- leaflet(shp, width = "100%") %>%
  addProviderTiles(map_type, group = "Background Map")
map <- map %>% addTAZPoints(data = ScenarioFirms, shp = shp,
                            group = "esizecat", weight = "Employees",
                            scale.factor = k) %>%
  addPolygons(data = shp, weight = 0.5,
              opacity = 0.25, color = "grey",
              fillOpacity = 0, fillColor = "white") %>%
  addTAZPolygons()
map %>% htmlwidgets::onRender(JS(paste0("function(el, x){
var map = this;
var corner1 = new L.LatLng(",CMAP_BBOX["y", "min"],", ",CMAP_BBOX["x", "min"],"),
    corner2 = new L.LatLng(",CMAP_BBOX["y", "max"],", ",CMAP_BBOX["x", "max"],"),
    bounds = new L.LatLngBounds(corner1, corner2);
map.fitBounds(bounds);
}")))
```

>`r if(SCENARIO_DB_FIRMSYN) {paste0("Note: Each data point represents ", comma(k), " employees and precise locations are illustrative as firms are only identified geographically at the TAZ-level.")}`

Column {data-width=500 .tabset}
--------------------------------------------
### Employment by Industry

```{r Chart_Employment_By_Industry}
# Organize
dat <- ScenarioFirms[, .(Employees = sum(Employees)), keyby = .(Region = TAZ_TYPE, Industry = EmpCatGroupedName)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Employees_by_Industry.csv"))
assign("db_tab_emp_industry", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Industry", yvar = "Employees",  fill = "Region", position = "dodge", coord_flip = TRUE)

```

### Employment by Size

```{r Chart_Employment_By_Size}
# Organize
dat <- ScenarioFirms[, .(Employees = sum(Employees)), keyby = .(Region = TAZ_TYPE, Size = esizecat)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Employees_by_Size.csv"))
assign("db_tab_emp_size", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Size", yvar = "Employees", xlabel = "Firm Size Category", 
            fill = "Region", position = "dodge", coord_flip = TRUE)

```

### Employment by District

```{r Chart_Employment_By_District}
# Organize
dat <- ScenarioFirms[, .(Employees = sum(Employees)), keyby = .(Region)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Employees_by_District.csv"))
assign("db_tab_emp_district", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Region", yvar = "Employees", xlabel = "District", coord_flip = TRUE)
```

### Employment by Industry and Size (CMAP)

```{r Chart_Employment_By_Industry_And_Size_CMAP}
# Organize
dat <- ScenarioFirms[TAZ_TYPE=="CMAP MPO Area", .(Employees = sum(Employees)), keyby = .(Industry = EmpCatGroupedName, Size = esizecat)]

dat <- add_totals(dcast.data.table(dat,
                     Industry ~ Size,
                     fun.aggregate = sum,
                     value.var = "Employees"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Employees_by_Industry_and_Size_CMAP.csv"))
assign("db_tab_emp_industry_size_cmap", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")


```

> Includes employment within the CMAP MPO region only

### Employment by Industry and Size (Rest of Model Region)

```{r Chart_Employment_By_Industry_And_Size_Rest_Region}
# Organize
dat <- ScenarioFirms[TAZ_TYPE=="Non-CMAP Part of Model Region", .(Employees = sum(Employees)), keyby = .(Industry = EmpCatGroupedName, Size = esizecat)]

dat <- add_totals(dcast.data.table(dat,
                     Industry ~ Size,
                     fun.aggregate = sum,
                     value.var = "Employees"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Employees_by_Industry_and_Size_Rest_Region.csv"))
assign("db_tab_emp_industry_size_rest_region", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")


```

> Includes employment within the Rest of Model Region only

### Employment by Industry and District

```{r Chart_Employment_By_Industry_And_District}
# Organize
dat <- ScenarioFirms[, .(Employees = sum(Employees)), keyby = .(Industry = EmpCatGroupedName, Region)]

dat <- add_totals(dcast.data.table(dat,
                     Industry ~ Region,
                     fun.aggregate = sum,
                     value.var = "Employees"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Employees_by_Industry_and_District.csv"))
assign("db_tab_emp_industry_district", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")


```

> Includes employment within the whole model region

```{r section_build_firm_sim_cal, results='asis', eval=SCENARIO_DB_CALIBRATION}
section_firm_sim_cal <- knitr::knit_child('section_firm_sim_cal.Rmd',
                              envir = environment(),
                              quiet = TRUE)
cat(unlist(section_firm_sim_cal), sep = '\n')
```

```{r section_build_firm_sim_ref, results='asis', eval=SCENARIO_DB_REFERENCE}
section_firm_sim_ref <- knitr::knit_child('section_firm_sim_ref.Rmd',
                              envir = environment(),
                              quiet = TRUE)
cat(unlist(section_firm_sim_ref), sep = '\n')
```
---
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
    css: "ReportDashboardStyles.css"
editor_options: 
  chunk_output_type: console
---
Validation {data-navmenu="Trip Tables"}
============================================

Highlights {data-width=150}
--------------------------------------------

**Trip Tables: Validation**

Daily trip table validation, comparing trip table characteristics such as county to county OD patterns with those derived from observed data such as truck GPS data.


Column {data-width=600, .tabset}
--------------------------------------------

### County Origins (All Vehicles) 

```{r Chart_tt_val_county_origins}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_all[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = ODistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_mod <- TripTable[, .(ModelTrips = sum(trips, na.rm = TRUE)), keyby = .(OriginCounty = OSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat <- merge(dat_obs, dat_mod, by= "OriginCounty", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, Ratio := ifelse(Target != 0, Model/Target, 0)]

dat[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]
setorder(dat, OriginCounty)

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_origins_all.csv"))
assign("db_tab_tt_build_county_origins_all", dat, envir = db_inputs)

# Table
kable(dat[,.(OriginCounty, Target, Model, Difference, Ratio)], escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) 

```


### County Destinations (All Vehicles) 

```{r Chart_tt_val_county_dest}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_all[, .(TargetTrips = sum(n)), keyby = .(DestinationCounty = DDistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_mod <- TripTable[, .(ModelTrips = sum(trips, na.rm = TRUE)), keyby = .(DestinationCounty = DSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat <- merge(dat_obs, dat_mod, by= "DestinationCounty", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, Ratio := ifelse(Target != 0, Model/Target, 0)]

dat[, DestinationCounty := factor(DestinationCounty, levels = levels(TAZ_System$DistrictName))]
setorder(dat, DestinationCounty)

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_dest_all.csv"))
assign("db_tab_tt_build_county_dest_all", dat, envir = db_inputs)

# Table
kable(dat[,.(DestinationCounty, Target, Model, Difference, Ratio)], escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) 

```

### County Origins (Light Vehicles) 

```{r Chart_tt_val_county_origins_light}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_light[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = ODistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_mod <- TripTable[Vehicle == "Light", .(ModelTrips = sum(trips, na.rm = TRUE)), keyby = .(OriginCounty = OSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat <- merge(dat_obs, dat_mod, by= "OriginCounty", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, Ratio := ifelse(Target != 0, Model/Target, 0)]

dat[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]
setorder(dat, OriginCounty)

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_origins_light.csv"))
assign("db_tab_tt_build_county_origins_light", dat, envir = db_inputs)

# Table
kable(dat[,.(OriginCounty, Target, Model, Difference, Ratio)], escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) 

```

### County Origins (Medium Trucks) 

```{r Chart_tt_val_county_origins_medium}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_medium[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = ODistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_mod <- TripTable[Vehicle == "Medium", .(ModelTrips = sum(trips, na.rm = TRUE)), keyby = .(OriginCounty = OSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat <- merge(dat_obs, dat_mod, by= "OriginCounty", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, Ratio := ifelse(Target != 0, Model/Target, 0)]

dat[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]
setorder(dat, OriginCounty)

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_origins_medium.csv"))
assign("db_tab_tt_build_county_origins_medium", dat, envir = db_inputs)

# Table
kable(dat[,.(OriginCounty, Target, Model, Difference, Ratio)], escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed"))

```

### Percent Trips by County OD: Model

```{r Chart_Percent_Trips_By_County_OD_val_mod}
# Organize
dat_mod <- TripTable[, .(ModelTrips = sum(trips, na.rm = TRUE)), by = .(OriginCounty = OSummaryGeog, DestinationCounty = DSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]
dat <- add_totals(dcast.data.table(dat_mod,
                                  OriginCounty ~ DestinationCounty,
                                   fun.aggregate = sum,
                                   value.var = "Model"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_od_val_mod.csv"))
assign("db_tab_tt_build_county_od_val_mod", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Percent Trips by County OD: Observed

```{r Chart_Percent_Trips_By_County_OD_obs}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_all[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = ODistrict, DestinationCounty = DDistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_obs[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]
dat_obs[, DestinationCounty := factor(DestinationCounty, levels = levels(TAZ_System$DistrictName))]

dat <- add_totals(dcast.data.table(dat_obs,
                                  OriginCounty ~ DestinationCounty,
                                   fun.aggregate = sum,
                                   value.var = "Target"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_od_val_obs.csv"))
assign("db_tab_tt_build_county_od_val_obs", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```


### Percent Trips by County OD: Difference (Model - Observed)

```{r Chart_Percent_Trips_By_County_OD_diff}
# Organize
dat_diff <- merge(dat_obs, dat_mod, by = c("OriginCounty", "DestinationCounty"))
dat_diff[, Difference := Model - Target]

dat <- dcast.data.table(dat_diff,
       OriginCounty ~ DestinationCounty,
       fun.aggregate = sum,
       value.var = "Difference")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_od_val_diff.csv"))
assign("db_tab_tt_build_county_od_val_diff", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed"))

```

### Percent Trips by Distance

```{r Chart_tt_trip_dist_Val}
# Organize
dat_mod <- TripTable[, .(ModelTrips = sum(trips)), keyby = .(Distance = round(dist,-1))]
dat_mod[is.na(ModelTrips), ModelTrips := 0]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tripdistancedist[, .(TargetTrips = sum(n)), keyby = .(Distance = round(Trip_dist,-1))]
dat_obs[is.na(TargetTrips), TargetTrips := 0]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]

dat <- merge(dat_obs, dat_mod, by= "Distance", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat <- melt.data.table(dat[, .(Distance, Model, Target)], id.vars = c("Distance"), variable.name = "Source", value.name = "PctTrips")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tripdistancedist_val.csv"))
assign("db_tab_tt_build_tripdistancedist_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Distance", yvar = "PctTrips",  fill = "Source", position = "dodge", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripdistancedist_val.png", xrotate = TRUE)

```

### Percent Trips by Distance and District: Model

```{r Chart_tt_trip_dist_Val_mod}
# Organize
dat_mod <- TripTable[, .(ModelTrips = sum(trips)), keyby = .(OriginCounty = ODistrictName, Distance = round(dist,-1))]
dat_mod[is.na(ModelTrips), ModelTrips := 0]
dat_mod[, Model := ModelTrips/sum(ModelTrips), by = OriginCounty]

dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tripdistancedist_district[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = BaseDistrict, Distance = round(Trip_dist,-1))]
dat_obs[is.na(TargetTrips), TargetTrips := 0]
dat_obs[, Target := TargetTrips/sum(TargetTrips), by = OriginCounty]

dat <- merge(dat_obs, dat_mod, by = c("Distance", "OriginCounty"), all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, DistanceLabel := paste0(Distance, "-", Distance+10)]
dat[, DistanceLabel := factor(DistanceLabel, levels = unique(dat[,.(DistanceLabel, Distance)])[order(Distance)]$DistanceLabel)]
dat[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]

dat_mod <- add_totals(dcast.data.table(dat,
                                  DistanceLabel ~ OriginCounty,
                                   fun.aggregate = sum,
                                   value.var = "Model"),
                      rowtotal = FALSE)

# Save
fwrite(dat_mod, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_distance_val_mod.csv"))
assign("db_tab_tt_build_county_distance_val_mod", dat_mod, envir = db_inputs)

# Table
kable(dat_mod, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat_mod), background = "#f2f2f2")

```

### Percent Trips by Distance and District: Observed

```{r Chart_tt_trip_dist_Val_obs}
# Organize

dat_obs <- add_totals(dcast.data.table(dat,
                                  DistanceLabel ~ OriginCounty,
                                   fun.aggregate = sum,
                                   value.var = "Target"),
                      rowtotal = FALSE)

# Save
fwrite(dat_obs, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_distance_val_obs.csv"))
assign("db_tab_tt_build_county_distance_val_obs", dat_obs, envir = db_inputs)

# Table
kable(dat_obs, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat_obs), background = "#f2f2f2")

```

### Percent Trips by Distance and District: Difference (Model - Observed)

```{r Chart_tt_trip_dist_Val_diff}
# Organize

dat_obs <- add_totals(dcast.data.table(dat,
                                  DistanceLabel ~ OriginCounty,
                                   fun.aggregate = sum,
                                   value.var = "Difference"),
                      rowtotal = FALSE)

# Save
fwrite(dat_obs, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_distance_val_diff.csv"))
assign("db_tab_tt_build_county_distance_val_diff", dat_obs, envir = db_inputs)

# Table
kable(dat_obs, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat_obs), background = "#f2f2f2")

```

### Percent Trips by Distance for Chicago

```{r Chart_tt_trip_dist_chicago_Val}
# Organize
dat <- melt.data.table(dat[, .(Distance, OriginCounty, Model, Target)], id.vars = c("OriginCounty", "Distance"), variable.name = "Source", value.name = "PctTrips")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tripdistancedist_district_val.csv"))
assign("db_tab_tt_build_tripdistancedist_district_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat[OriginCounty == "Chicago"], xvar = "Distance", yvar = "PctTrips",  fill = "Source", position = "dodge", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripdistancedist_chicago_val.png", xrotate = TRUE)

```

### Percent Trips by Distance for Cook County (Outside Chicago)

```{r Chart_tt_trip_dist_cook_Val}
# Plot
bar_plotter(dat[OriginCounty == "COOK, IL (Outside Chicago)"], xvar = "Distance", yvar = "PctTrips",  fill = "Source", position = "dodge", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripdistancedist_cook_val.png", xrotate = TRUE)
```

### Percent Trips by Distance for Rest of CMAP MPO Area (Outside Cook)

```{r Chart_tt_trip_dist_cmap_Val}
dat <- dat[!OriginCounty %in% c("Chicago", "COOK, IL (Outside Chicago)", "Non-CMAP Part of Model Regio"),
           .(PctTrips = sum(PctTrips)), keyby = .(Distance, Source)]

# Plot
bar_plotter(dat, xvar = "Distance", yvar = "PctTrips",  fill = "Source", position = "dodge", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripdistancedist_cmap_val.png", xrotate = TRUE)

```
---
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
    css: "ReportDashboardStyles.css"
editor_options: 
  chunk_output_type: console
---
Validation {data-navmenu="Trip Tables"}
============================================

Highlights {data-width=150}
--------------------------------------------

**Trip Tables: Validation**

Daily trip table validation, comparing trip table characteristics such as county to county OD patterns with those derived from observed data such as truck GPS data.

### Validation Summary

```{r Chart_tt_val_summary_tab}
# Organize
# summary/mean values in a table with measure, model, target

# average trip distance
# average tour distance
# average tour time
# average stops per tour (excluding return stop)
# percent single stop tours (vs multistop)
# average base to stop distance
# average cluster distance
# average stop duration

dat <- cal_results$calibration_targets_tt_sim$tt_build$gps_summary_table[,.(Field, Statistic, Observed = value)]

dat[Field == "Trips: Distance", Model := round(mean(cv_trips$Distance, na.rm = TRUE), 2)]
dat[Field == "Tours: Distance", Model := round(mean(cv_trips[,.(Distance = sum(Distance)), by = TourID]$Distance),2)]
dat[Field == "Tours: Number of Stops (Excluding Return to Base)", Model := round(mean(cv_trips[Activity != "Return",.(NumStops = .N), by = TourID]$NumStops),2)]
dat[Field == "Tours: Single Stop Tours (vs. Multi-Stop)", Model := round((cv_trips[Activity != "Return",.N,by = TourID][N==1,.N])/uniqueN(cv_trips$TourID),2)]
dat[Field == "Trips: Base-to-StopDistance", Model := round(mean(cv_trips[Activity != "Return"]$Distance.Start),2)]
dat[Field == "Tours: Cluster Distance", Model := round(mean(cv_trips_cluster$MeanDist),2)]
dat[Field == "Trips: Stop Duration", Model := round(mean(cv_trips[Activity != "Return"]$StopDuration),2)]
dat[Field == "Tours: Tour Duration", Model := round(mean(cv_trips[,.(TourDuration = sum(TravelTime, StopDuration)), by = TourID]$TourDuration),2)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_val_summary_tab.csv"))
assign("db_tab_tt_build_val_summary_tab", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) 

```


Column {data-width=600, .tabset}
--------------------------------------------

### County Origins (All Vehicles) 

```{r Chart_tt_val_county_origins}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_all[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = ODistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_mod <- TripTable[, .(ModelTrips = sum(trips, na.rm = TRUE)), keyby = .(OriginCounty = OSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat <- merge(dat_obs, dat_mod, by= "OriginCounty", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, Ratio := ifelse(Target != 0, Model/Target, 0)]

dat[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]
setorder(dat, OriginCounty)

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_origins_all.csv"))
assign("db_tab_tt_build_county_origins_all", dat, envir = db_inputs)

# Table
kable(dat[,.(OriginCounty, Target, Model, Difference, Ratio)], escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) 

```


### County Destinations (All Vehicles) 

```{r Chart_tt_val_county_dest}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_all[, .(TargetTrips = sum(n)), keyby = .(DestinationCounty = DDistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_mod <- TripTable[, .(ModelTrips = sum(trips, na.rm = TRUE)), keyby = .(DestinationCounty = DSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat <- merge(dat_obs, dat_mod, by= "DestinationCounty", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, Ratio := ifelse(Target != 0, Model/Target, 0)]

dat[, DestinationCounty := factor(DestinationCounty, levels = levels(TAZ_System$DistrictName))]
setorder(dat, DestinationCounty)

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_dest_all.csv"))
assign("db_tab_tt_build_county_dest_all", dat, envir = db_inputs)

# Table
kable(dat[,.(DestinationCounty, Target, Model, Difference, Ratio)], escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) 

```

### County Origins (Light Vehicles) 

```{r Chart_tt_val_county_origins_light}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_light[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = ODistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_mod <- TripTable[Vehicle == "Light", .(ModelTrips = sum(trips, na.rm = TRUE)), keyby = .(OriginCounty = OSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat <- merge(dat_obs, dat_mod, by= "OriginCounty", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, Ratio := ifelse(Target != 0, Model/Target, 0)]

dat[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]
setorder(dat, OriginCounty)

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_origins_light.csv"))
assign("db_tab_tt_build_county_origins_light", dat, envir = db_inputs)

# Table
kable(dat[,.(OriginCounty, Target, Model, Difference, Ratio)], escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) 

```

### County Origins (Medium Trucks) 

```{r Chart_tt_val_county_origins_medium}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_medium[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = ODistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_mod <- TripTable[Vehicle == "Medium", .(ModelTrips = sum(trips, na.rm = TRUE)), keyby = .(OriginCounty = OSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat <- merge(dat_obs, dat_mod, by= "OriginCounty", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, Ratio := ifelse(Target != 0, Model/Target, 0)]

dat[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]
setorder(dat, OriginCounty)

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_origins_medium.csv"))
assign("db_tab_tt_build_county_origins_medium", dat, envir = db_inputs)

# Table
kable(dat[,.(OriginCounty, Target, Model, Difference, Ratio)], escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed"))

```

### Percent Trips by County OD: Model

```{r Chart_Percent_Trips_By_County_OD_val_mod}
# Organize
dat_mod <- TripTable[, .(ModelTrips = sum(trips, na.rm = TRUE)), by = .(OriginCounty = OSummaryGeog, DestinationCounty = DSummaryGeog)]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]
dat <- add_totals(dcast.data.table(dat_mod,
                                  OriginCounty ~ DestinationCounty,
                                   fun.aggregate = sum,
                                   value.var = "Model"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_od_val_mod.csv"))
assign("db_tab_tt_build_county_od_val_mod", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Percent Trips by County OD: Observed

```{r Chart_Percent_Trips_By_County_OD_obs}
# Organize
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$districtod_all[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = ODistrict, DestinationCounty = DDistrict)]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]
dat_obs[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]
dat_obs[, DestinationCounty := factor(DestinationCounty, levels = levels(TAZ_System$DistrictName))]

dat <- add_totals(dcast.data.table(dat_obs,
                                  OriginCounty ~ DestinationCounty,
                                   fun.aggregate = sum,
                                   value.var = "Target"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_od_val_obs.csv"))
assign("db_tab_tt_build_county_od_val_obs", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```


### Percent Trips by County OD: Difference (Model - Observed)

```{r Chart_Percent_Trips_By_County_OD_diff}
# Organize
dat_diff <- merge(dat_obs, dat_mod, by = c("OriginCounty", "DestinationCounty"))
dat_diff[, Difference := Model - Target]

dat <- dcast.data.table(dat_diff,
       OriginCounty ~ DestinationCounty,
       fun.aggregate = sum,
       value.var = "Difference")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_od_val_diff.csv"))
assign("db_tab_tt_build_county_od_val_diff", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed"))

```

### Percent Trips by Distance

```{r Chart_tt_trip_dist_Val}
# Organize
dat_mod <- TripTable[, .(ModelTrips = sum(trips)), keyby = .(Distance = round(dist,-1))]
dat_mod[is.na(ModelTrips), ModelTrips := 0]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]

dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tripdistancedist[, .(TargetTrips = sum(n)), keyby = .(Distance = round(Trip_dist,-1))]
dat_obs[is.na(TargetTrips), TargetTrips := 0]
dat_obs[, Target := TargetTrips/sum(TargetTrips)]

dat <- merge(dat_obs, dat_mod, by= "Distance", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat <- melt.data.table(dat[, .(Distance, Model, Target)], id.vars = c("Distance"), variable.name = "Source", value.name = "PctTrips")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tripdistancedist_val.csv"))
assign("db_tab_tt_build_tripdistancedist_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Distance", yvar = "PctTrips",  fill = "Source", position = "dodge", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripdistancedist_val.png", xrotate = TRUE)

```

### Percent Trips by Distance and District: Model

```{r Chart_tt_trip_dist_Val_mod}
# Organize
dat_mod <- TripTable[, .(ModelTrips = sum(trips)), keyby = .(OriginCounty = ODistrictName, Distance = round(dist,-1))]
dat_mod[is.na(ModelTrips), ModelTrips := 0]
dat_mod[, Model := ModelTrips/sum(ModelTrips), by = OriginCounty]

dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tripdistancedist_district[, .(TargetTrips = sum(n)), keyby = .(OriginCounty = tripOrigin_District, Distance = round(Trip_dist,-1))]
dat_obs[is.na(TargetTrips), TargetTrips := 0]
dat_obs[, Target := TargetTrips/sum(TargetTrips), by = OriginCounty]

dat <- merge(dat_obs, dat_mod, by = c("Distance", "OriginCounty"), all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat[, Difference := Model - Target]
dat[, DistanceLabel := paste0(Distance, "-", Distance+10)]
dat[, DistanceLabel := factor(DistanceLabel, levels = unique(dat[,.(DistanceLabel, Distance)])[order(Distance)]$DistanceLabel)]
dat[, OriginCounty := factor(OriginCounty, levels = levels(TAZ_System$DistrictName))]

dat_mod <- add_totals(dcast.data.table(dat,
                                  DistanceLabel ~ OriginCounty,
                                   fun.aggregate = sum,
                                   value.var = "Model"),
                      rowtotal = FALSE)

# Save
fwrite(dat_mod, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_distance_val_mod.csv"))
assign("db_tab_tt_build_county_distance_val_mod", dat_mod, envir = db_inputs)

# Table
kable(dat_mod, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat_mod), background = "#f2f2f2")

```

### Percent Trips by Distance and District: Observed

```{r Chart_tt_trip_dist_Val_obs}
# Organize

dat_obs <- add_totals(dcast.data.table(dat,
                                  DistanceLabel ~ OriginCounty,
                                   fun.aggregate = sum,
                                   value.var = "Target"),
                      rowtotal = FALSE)

# Save
fwrite(dat_obs, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_distance_val_obs.csv"))
assign("db_tab_tt_build_county_distance_val_obs", dat_obs, envir = db_inputs)

# Table
kable(dat_obs, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat_obs), background = "#f2f2f2")

```

### Percent Trips by Distance and District: Difference (Model - Observed)

```{r Chart_tt_trip_dist_Val_diff}
# Organize

dat_obs <- add_totals(dcast.data.table(dat,
                                  DistanceLabel ~ OriginCounty,
                                   fun.aggregate = sum,
                                   value.var = "Difference"),
                      rowtotal = FALSE)

# Save
fwrite(dat_obs, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_county_distance_val_diff.csv"))
assign("db_tab_tt_build_county_distance_val_diff", dat_obs, envir = db_inputs)

# Table
kable(dat_obs, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat_obs), background = "#f2f2f2")

```

### Percent Trips by Distance for Chicago

```{r Chart_tt_trip_dist_chicago_Val}
# Organize
dat <- melt.data.table(dat[, .(Distance, OriginCounty, Model, Target)], id.vars = c("OriginCounty", "Distance"), variable.name = "Source", value.name = "PctTrips")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tripdistancedist_district_val.csv"))
assign("db_tab_tt_build_tripdistancedist_district_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat[OriginCounty == "Chicago"], xvar = "Distance", yvar = "PctTrips",  fill = "Source", position = "dodge", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripdistancedist_chicago_val.png", xrotate = TRUE)

```

### Percent Trips by Distance for Cook County (Outside Chicago)

```{r Chart_tt_trip_dist_cook_Val}
# Plot
bar_plotter(dat[OriginCounty == "COOK, IL (Outside Chicago)"], xvar = "Distance", yvar = "PctTrips",  fill = "Source", position = "dodge", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripdistancedist_cook_val.png", xrotate = TRUE)
```

### Percent Trips by Distance for Rest of CMAP MPO Area (Outside Cook)

```{r Chart_tt_trip_dist_cmap_Val}
dat <- dat[!OriginCounty %in% c("Chicago", "COOK, IL (Outside Chicago)", "Non-CMAP Part of Model Regio"),
           .(PctTrips = sum(PctTrips)), keyby = .(Distance, Source)]
dat[, PctTrips := PctTrips/sum(PctTrips), keyby = Source]

# Plot
bar_plotter(dat, xvar = "Distance", yvar = "PctTrips",  fill = "Source", position = "dodge", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripdistancedist_cmap_val.png", xrotate = TRUE)

```

### Mean Base to Stop Distance

```{r Chart_tt_trip_base_stop_dist_Val}
# Organize

# for this summary comparing the final set of trips base location to stop location distance
# use the cv_trips table as the TripTable is too aggregated
dat_mod <- cv_trips[Activity != "Return", .(Model = mean(Distance.Start)), keyby = .(BaseDistrict = Region.Start)]
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$basestopdist_district[statistic == "n", .(BaseDistrict, Target = mean_dist)]

dat <- merge(dat_obs, dat_mod, by= "BaseDistrict", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]
dat[, BaseDistrict := factor(BaseDistrict, levels = levels(TAZ_System$DistrictName))]

dat <- melt.data.table(dat[, .(BaseDistrict, Model, Target)], id.vars = c("BaseDistrict"), variable.name = "Source", value.name = "Distance")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_basestopdistance_val.csv"))
assign("db_tab_tt_build_basestopdistance_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "BaseDistrict", yvar = "Distance",  fill = "Source", position = "dodge", ylabel = "Average Base to Stop Distance", png_name = "p_tt_build_basestopdistance_val.png", coord_flip = TRUE)

```

### Stop Duration

```{r Chart_tt_stop_duration_Val}
# Organize

# for this summary comparing the complete set of stop durations base 
# use the cv_trips table as the TripTable is too aggregated
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$duration_stop_dist[, .(duration_group, Target)]
duration_bins <- c(0,16,31,46,61,76,91,151,211,271)

dat_mod <- cv_trips[Activity != "Return", .(ModelDuration = StopDuration)]
dat_mod[, duration_group := dat_obs$duration_group[findInterval(ModelDuration, duration_bins)]]
dat_mod <- dat_mod[, .(ModelStops = .N), keyby = duration_group]
dat_mod[, Model := ModelStops/sum(ModelStops)]

dat <- merge(dat_obs, dat_mod, by= "duration_group", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]
dat[, duration_group := factor(duration_group, levels = dat_obs$duration_group)]

dat <- melt.data.table(dat[, .(duration_group, Model, Target)], id.vars = c("duration_group"), variable.name = "Source", value.name = "PctStops")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_stop_duration_val.csv"))
assign("db_tab_tt_build_stop_duration_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "duration_group", yvar = "PctStops",  fill = "Source", position = "dodge", xlabel = "Stop Duration", ylabel = "Percentage of Stops", png_name = "p_tt_build_stop_duration_val.png", xrotate = TRUE)

```

### Tour Cluster Size

```{r Chart_tt_tour_cluster_Val}
# Organize

# for this summary comparing the complete set of cluster distances for multistop tours 
# use the cv_trips table as the TripTable is too aggregated
dist_bin <- c(0,1,seq(5,50,by = 5))
dist_label <- c("0", paste(dist_bin[2:(length(dist_bin)-1)], dist_bin[3:length(dist_bin)]-1, sep="-"), "50+")
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tour_cluster[, .(TourMatrixAvgDist, Target)]
dat_obs[, distance_group := dist_label[findInterval(TourMatrixAvgDist, dist_bin)]]
dat_obs <- dat_obs[,.(Target = sum(Target)), keyby = distance_group]
dat_mod <- cv_trips_cluster[,.(ModelTours = .N), keyby = .(TourMatrixAvgDist = floor(MeanDist))]
dat_mod[, distance_group := dist_label[findInterval(TourMatrixAvgDist, dist_bin)]]
dat_mod[, Model := ModelTours/sum(ModelTours)]
dat_mod <- dat_mod[,.(Model = sum(Model)), keyby = distance_group]

dat <- merge(dat_obs, dat_mod, by= "distance_group", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]
dat[, distance_group := factor(distance_group, levels = dist_label)]

dat <- melt.data.table(dat[, .(distance_group, Model, Target)], id.vars = c("distance_group"), variable.name = "Source", value.name = "PctTours")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tour_cluster_val.csv"))
assign("db_tab_tt_build_tour_cluster_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "distance_group", yvar = "PctTours",  fill = "Source", position = "dodge", xlabel = "Tour Cluster Distance", ylabel = "Percentage of Tours", png_name = "p_tt_build_tour_cluster_val.png", xrotate = TRUE)

```


### Tour Distance Distribution

```{r Chart_tt_tour_distance_dist_Val}
# Organize

# for this summary comparing the final set of tour distances
# use the cv_trips table as the TripTable is too aggregated
dat_mod <- cv_trips[, .(TourDistance = sum(Distance)), keyby = TourID]
TourDistLabels = cal_results$calibration_targets_tt_sim$tt_build$tourdistance$TourDist
dat_mod[, TourDist := TourDistLabels[findInterval(TourDistance, c(0,30,60,120,180,240,360,480))]]
dat_mod <- dat_mod[, .(ModelTours = .N), keyby = TourDist ]
dat_mod[, Model := ModelTours/sum(ModelTours)]
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tourdistance[, .(TourDist, Target)]

dat <- merge(dat_obs, dat_mod[,.(TourDist, Model)], by= "TourDist", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]
dat[, TourDist := factor(TourDist, levels = TourDistLabels)]

dat <- melt.data.table(dat[, .(TourDist, Model, Target)], id.vars = c("TourDist"), variable.name = "Source", value.name = "PctTours")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tourdistance_val.csv"))
assign("db_tab_tt_build_tourdistance_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "TourDist", yvar = "PctTours",  fill = "Source", position = "dodge", ylabel = "Percentage of Tours", png_name = "p_tt_build_tourdistance_val.png", coord_flip = TRUE)

```

### Tour Number of Stops Distribution

```{r Chart_tt_tour_numstops_dist_Val}
# Organize

# for this summary comparing the final set of tour stops
# use the cv_trips table as the TripTable is too aggregated
dat_mod <- cv_trips[Activity != "Return", .(NStops = .N), keyby = TourID]
dat_mod <- dat_mod[, .(ModelTours = .N), keyby = NStops ]
dat_mod[, Model := ModelTours/sum(ModelTours)]
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tournumstopsdistance[, .(NStops, Target)]

dat <- merge(dat_obs, dat_mod[,.(NStops, Model)], by= "NStops", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat <- melt.data.table(dat[, .(NStops, Model, Target)], id.vars = c("NStops"), variable.name = "Source", value.name = "PctTours")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tournumstops_val.csv"))
assign("db_tab_tt_build_tournumstops_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "NStops", yvar = "PctTours",  fill = "Source", position = "dodge", xlabel = "Number of Stops on the Tour", ylabel = "Percentage of Tours", png_name = "p_tt_build_tournumstops_val.png")

```

### Tour First Stop Arrival Time

```{r Chart_tt_tour_first_stop_time_Val}
# Organize

# for this summary comparing the final set of tour first stop arrival times
# use the cv_trips table as the TripTable is too aggregated
dat_mod <- cv_trips[TripID == 1, .(StopTime = floor(as.numeric(MAMArrive)/60)), keyby = TourID]
dat_mod <- dat_mod[, .(ModelTours = .N), keyby = StopTime]
dat_mod[, Model := ModelTours/sum(ModelTours)]
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tourfirststoparrival[,.(Target = sum(Target)), keyby = .(StopTime = floor(startHour))]

dat <- merge(dat_obs, dat_mod[,.(StopTime, Model)], by= "StopTime", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat <- melt.data.table(dat[, .(StopTime, Model, Target)], id.vars = c("StopTime"), variable.name = "Source", value.name = "PctTours")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tourfirststoptime_val.csv"))
assign("db_tab_tt_build_tourfirststoptime_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "StopTime", yvar = "PctTours",  fill = "Source", position = "dodge", xlabel = "Arrival Time at the First Stop on the Tour", ylabel = "Percentage of Tours", png_name = "p_tt_build_tourfirststoptime_val.png")

```

### Trip Start Time by Hour

```{r Chart_tt_trip_start_time_Val}
# Organize

# for this summary comparing the final set of trip start times
# use the cv_trips table as the TripTable is too aggregated
dat_mod <- cv_trips[, .(StopTime = floor(as.numeric(MAMDepart)/60))]
dat_mod <- dat_mod[, .(ModelTrips = .N), keyby = StopTime]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tripstarttimedist[,.(Target = sum(Target)), keyby = .(StopTime = floor(StopDepartHour))]

dat <- merge(dat_obs, dat_mod[,.(StopTime, Model)], by= "StopTime", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat <- melt.data.table(dat[, .(StopTime, Model, Target)], id.vars = c("StopTime"), variable.name = "Source", value.name = "PctTrips")

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tripstarttime_val.csv"))
assign("db_tab_tt_build_tripstarttime_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "StopTime", yvar = "PctTrips",  fill = "Source", position = "dodge", xlabel = "Trip Start Hour", ylabel = "Percentage of Trips", png_name = "p_tt_build_tripstarttime_val.png")

```

### Trip Start Time by Time Period

```{r Chart_tt_trip_start_tod_Val}
# Organize

# for this summary comparing the final set of trip start times
# use the cv_trips table as the TripTable is too aggregated
dat_mod <- cv_trips[, .(ModelTrips = .N), keyby = TOD]
dat_mod[, Model := ModelTrips/sum(ModelTrips)]
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tripstarttimedist[,.(Target = sum(Target)), keyby = .(StopTime = floor(StopDepartHour))]

# p1 - 8 pm to 6 am
# p2 - 6 am to 7 am
# p3 - 7 am to 9 am
# p4 - 9 am to 10 am
# p5 - 10 am to 2 pm
# p6 - 2 pm to 4 pm
# p7 - 4 pm to 6 pm
# p8 - 6 pm to 8 pm
dat_obs[, TOD := c(rep("P1",6),"P2", rep("P3",2), "P4", rep("P5",4), rep("P6",2), rep("P7",2), rep("P8",2), rep("P1", 4))]
dat_obs <- dat_obs[,.(Target = sum(Target)), keyby = TOD]

dat <- merge(dat_obs, dat_mod[,.(TOD, Model)], by= "TOD", all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat <- melt.data.table(dat[, .(TOD, Model, Target)], id.vars = c("TOD"), variable.name = "Source", value.name = "PctTrips")
dat[tod_labels, Hours := i.Hours, on = "TOD"]
dat[, TOD_Label := paste(TOD, Hours)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tripstarttime_tod_val.csv"))
assign("db_tab_tt_build_tripstarttime_tod_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "TOD_Label", yvar = "PctTrips",  fill = "Source", position = "dodge", xlabel = "Trip Start Time Period", ylabel = "Percentage of Trips", xrotate = TRUE, png_name = "p_tt_build_tripstarttime_tod_val.png")

```

### Trip Start Time by Time Period for Chicago

```{r Chart_tt_trip_start_tod_chicago_Val}
# Organize

# for this summary comparing the final set of trip start times
# use the cv_trips table as the TripTable is too aggregated
dat_mod <- cv_trips[, .(ModelTrips = .N), keyby = .(TOD, OriginCounty = Region.Origin)]
dat_mod[, Model := ModelTrips/sum(ModelTrips), keyby = OriginCounty]
dat_obs <- cal_results$calibration_targets_tt_sim$tt_build$tripstarttimedist_district[,.(Target = sum(Target)), keyby = .(StopTime = floor(StopDepartHour), OriginCounty = tripOrigin_district)]

# p1 - 8 pm to 6 am
# p2 - 6 am to 7 am
# p3 - 7 am to 9 am
# p4 - 9 am to 10 am
# p5 - 10 am to 2 pm
# p6 - 2 pm to 4 pm
# p7 - 4 pm to 6 pm
# p8 - 6 pm to 8 pm
tod_hours <- data.table(StopTime = 0:23,
                        TOD = c(rep("P1",6),"P2", rep("P3",2), "P4", rep("P5",4), rep("P6",2), rep("P7",2), rep("P8",2), rep("P1", 4)))

dat_obs[tod_hours, TOD := i.TOD, on = "StopTime"]
dat_obs <- dat_obs[,.(Target = sum(Target)), keyby = .(TOD, OriginCounty)]

dat <- merge(dat_obs, dat_mod[,.(OriginCounty, TOD, Model)], by = c("TOD", "OriginCounty"), all = TRUE)
dat[is.na(Target), Target := 0]
dat[is.na(Model), Model := 0]

dat <- melt.data.table(dat, id.vars = c("OriginCounty", "TOD"), variable.name = "Source", value.name = "PctTrips")
dat[tod_labels, Hours := i.Hours, on = "TOD"]
dat[, TOD_Label := paste(TOD, Hours)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "tt_build_tripstarttime_tod_district_val.csv"))
assign("db_tab_tt_build_tripstarttime_tod_district_val", dat, envir = db_inputs)

# Plot
bar_plotter(dat[OriginCounty == "Chicago"], xvar = "TOD_Label", yvar = "PctTrips",  fill = "Source", position = "dodge", xlabel = "Trip Start Time Period", ylabel = "Percentage of Trips", xrotate = TRUE, png_name = "p_tt_build_tripstarttime_tod_chicago_val.png")

```

### Trip Start Time by Time Period for Cook County (Outside Chicago)

```{r Chart_tt_trip_start_tod_cook_Val}

# Plot
bar_plotter(dat[OriginCounty == "COOK, IL (Outside Chicago)"], xvar = "TOD_Label", yvar = "PctTrips",  fill = "Source", position = "dodge", xlabel = "Trip Start Time Period", ylabel = "Percentage of Trips", xrotate = TRUE, png_name = "p_tt_build_tripstarttime_tod_cook_val.png")

```

### Trip Start Time by Time Period for Rest of CMAP MPO Area (Outside Cook)

```{r Chart_tt_trip_start_tod_cmap_Val}

dat <- dat[!OriginCounty %in% c("Chicago", "COOK, IL (Outside Chicago)", "Non-CMAP Part of Model Regio"),
           .(PctTrips = sum(PctTrips)), keyby = .(TOD_Label, Source)]
dat[, PctTrips := PctTrips/sum(PctTrips), keyby = Source]

# Plot
bar_plotter(dat, xvar = "TOD_Label", yvar = "PctTrips",  fill = "Source", position = "dodge", xlabel = "Trip Start Time Period", ylabel = "Percentage of Trips", xrotate = TRUE, png_name = "p_tt_build_tripstarttime_tod_cmap_val.png")

```


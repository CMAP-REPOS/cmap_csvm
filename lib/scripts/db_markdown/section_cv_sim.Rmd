---
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
    css: "ReportDashboardStyles.css"
editor_options: 
  chunk_output_type: console
---

Stops - Geography {data-navmenu="Commercial Vehicle Touring Model"}
============================================

Highlights {data-width=150}
--------------------------------------------

**Commercial Vehicle Touring Model: Stops and Geography**

Commercial vehicle stops by vehicle type, activity, and location

### Stops City of Chicago

```{r Commercial_Vehicle_Total_Stops_ValueBox_Chicago2}
value <- format(cv_trips[DTAZ %in% BASE_TAZ_CHICAGO, .N], 
                big.mark = ",", trim = TRUE)
valueBox(value, "Stops<br>City of Chicago</br>", icon = "fa-map-marker")
```

### Stops Cook County Outside Chicago

```{r Commercial_Vehicle_Total_Stops_ValueBox_Cook2}
value <- format(cv_trips[DTAZ %in% BASE_TAZ_COOK & !DTAZ %in% BASE_TAZ_CHICAGO, .N], 
                big.mark = ",", trim = TRUE)
valueBox(value, "Stops<br>Cook County (Not Chicago)</br>", icon = "fa-map-marker")
```

### Stops Rest of CMAP MPO Area (Not Cook County)

```{r Commercial_Vehicle_Total_Stops_ValueBox_CMAP2}
value <- format(cv_trips[DTAZ %in% BASE_TAZ_CMAP & !DTAZ %in% BASE_TAZ_COOK, .N], 
                big.mark = ",", trim = TRUE)
valueBox(value, "Stops<br>Rest of CMAP MPO Area (Not Cook County)</br>", icon = "fa-map-marker")
```

### Stops Rest of Region

```{r Commercial_Vehicle_Total_Stops_ValueBox_NonCMAP}
value <- format(cv_trips[!DTAZ %in% BASE_TAZ_CMAP, .N], 
                big.mark = ",", trim = TRUE)
valueBox(value, "Stops<br>Rest of Model Region</br>", icon = "fa-map-marker")
```

### Stops Model Region

```{r Commercial_Vehicle_Total_Stops_ValueBox}
value <- format(cv_trips[, .N], 
                big.mark = ",", trim = TRUE)
valueBox(value, "Stops<br>Model Region</br>", icon = "fa-map-marker")
```


Column {data-width=475, .tabset}
--------------------------------------------
### Stops by Vehicle Type

```{r Map_Commercial_Stops_By_Vehicle}
k <- 50
map <- leaflet() %>%
  addProviderTiles(map_type, group = "Background Map")
map <- map %>% addTAZPoints(data = cv_trips[Activity != "Return"],
                            shp = shp, group = "Vehicle",
                            scale.factor = k, TAZcol = "DTAZ") %>%
  addPolygons(data = shp, weight = 0.5,
              opacity = 0.25, color = "grey",
              fillOpacity = 0, fillColor = "white") %>%
  addTAZPolygons()
map %>% htmlwidgets::onRender(JS(paste0("function(el, x){
var map = this;
var corner1 = new L.LatLng(",CMAP_BBOX["y", "min"],", ",CMAP_BBOX["x", "min"],"),
    corner2 = new L.LatLng(",CMAP_BBOX["y", "max"],", ",CMAP_BBOX["x", "max"],"),
    bounds = new L.LatLngBounds(corner1, corner2);
map.fitBounds(bounds);
}")))
```

>`r if(SCENARIO_RUN_CVTM) {paste0("Note: Each data point represents ", comma(k), " stops and precise locations are illustrative as firms are only identified geographically at the TAZ-level.")}`

### Stops by Activity

```{r Map_Commercial_Stops_By_Activity}
k <- 50
map <- leaflet() %>%
  addProviderTiles(map_type, group = "Background Map")
map <- map %>% addTAZPoints(data = cv_trips[Activity != "Return"],
                            shp = shp, group = "Activity",
                            scale.factor = k, TAZcol = "DTAZ") %>%
  addPolygons(data = shp, weight = 0.5,
              opacity = 0.25, color = "grey",
              fillOpacity = 0, fillColor = "white") %>%
  addTAZPolygons()
map %>% htmlwidgets::onRender(JS(paste0("function(el, x){
var map = this;
var corner1 = new L.LatLng(",CMAP_BBOX["y", "min"],", ",CMAP_BBOX["x", "min"],"),
    corner2 = new L.LatLng(",CMAP_BBOX["y", "max"],", ",CMAP_BBOX["x", "max"],"),
    bounds = new L.LatLngBounds(corner1, corner2);
map.fitBounds(bounds);
}")))
```

>`r if(SCENARIO_RUN_CVTM) {paste0("Note: Each data point represents ", comma(k), " stops and precise locations are illustrative as firms are only identified geographically at the TAZ-level.")}`


Column {data-width=375, .tabset}
--------------------------------------------
### Stop Activities by District

```{r Chart_Commercial_Stop_Activity_by_District}
# Organize
dat <- cv_trips[,.N, keyby = .(District = Region.Destination, Activity)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Stop_Activity_by_District.csv"), row.names = FALSE)
assign("db_tab_cv_stop_activity_district", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "District", yvar = "N", fill = "Activity", xlabel = "Stop Location District", ylabel = "Commercial Vehicle Stops", coord_flip = TRUE)
```

### Stop Activities by District for Light Vehicles

```{r Chart_Commercial_Stop_Activity_by_District_Light}
# Organize
dat <- cv_trips[Vehicle == "Light",.N, keyby = .(District = Region.Destination, Activity)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Stop_Activity_by_District_Light.csv"), row.names = FALSE)
assign("db_tab_cv_stop_activity_district_light", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "District", yvar = "N", fill = "Activity", xlabel = "Stop Location District", ylabel = "Light Vehicle Stops", coord_flip = TRUE)
```

### Stop Activities by District for Medium Trucks

```{r Chart_Commercial_Stop_Activity_by_District_Medium}
# Organize
dat <- cv_trips[Vehicle == "Medium",.N, keyby = .(District = Region.Destination, Activity)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Stop_Activity_by_District_Medium.csv"), row.names = FALSE)
assign("db_tab_cv_stop_activity_district_medium", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "District", yvar = "N", fill = "Activity", xlabel = "Stop Location District", ylabel = "Medium Truck Stops", coord_flip = TRUE)
```

### Stop Activities by District for Heavy Trucks

```{r Chart_Commercial_Stop_Activity_by_District_Heavy}
# Organize
dat <- cv_trips[Vehicle == "Heavy",.N, keyby = .(District = Region.Destination, Activity)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Stop_Activity_by_District_Heavy.csv"), row.names = FALSE)
assign("db_tab_cv_stop_activity_district_heavy", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "District", yvar = "N", fill = "Activity", xlabel = "Stop Location District", ylabel = "Heavy Vehicle Stops", coord_flip = TRUE)
```

### Stop Activities by District and Vehicle (Table)

```{r Table_Commercial_Stop_Activity_by_District_Vehicle}
# Organize
dat <- cv_trips[,.N, keyby = .(District = Region.Destination, Activity, Vehicle)]

dat <- add_totals(dcast.data.table(dat,
                                  Vehicle + Activity ~ District,
                                   fun.aggregate = sum,
                                   value.var = "N"),
                  idcols = 2L)
dat[is.na(Vehicle), Vehicle := ""]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Stop_Activity_by_District_Vehicle.csv"), row.names = FALSE)
assign("db_tab_cv_stop_activity_district_vehicle", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

> Stops counts include "Return" activities, i.e., the stop completing a tour (usually at the truck base location for tours that are closed tours that start and end at the truck base location).

Stops - Timing {data-navmenu="Commercial Vehicle Touring Model"}
============================================

Highlights {data-width=150}
--------------------------------------------

**Commercial Vehicle Touring Model: Stops and Timing**

Commercial vehicle stops by time of day and stop duration

### Goods Stops

```{r Commercial_Vehicle_Goods_Stops_ValueBox}
value <- format(cv_trips[Activity == "Goods", .N], big.mark = ",", trim = TRUE)
valueBox(value, "Goods Deliveries<br>(Model Region)</br>", icon = "fa-cube")
```

### Service Stops 

```{r Commercial_Vehicle_Service_Stops_ValueBox}
value <- format(cv_trips[Activity == "Service", .N], big.mark = ",", trim = TRUE)
valueBox(value, "Service Stops<br>(Model Region)</br>", icon = "fa-wrench")
```

### Intermediate Stops

```{r Commercial_Vehicle_Intermediate_Stops_ValueBox}
value <- format(cv_trips[Scheduled == 0L, .N], big.mark = ",", trim = TRUE)
valueBox(value, "Non-Scheduled Stops<br>(Model Region)</br>", icon = "fa-cutlery")
```

### Return Stops 

```{r Commercial_Vehicle_Return_Stops_ValueBox}
value <- format(cv_trips[Activity == "Return", .N], 
                big.mark = ",", trim = TRUE)
valueBox(value, "Return Stops<br>(Model Region)</br>", icon = "fa-building-o")
```

### Total Stops

```{r Commercial_Vehicle_Total_Stops_ValueBox2}
value <- format(cv_trips[, .N], 
                big.mark = ",", trim = TRUE)
valueBox(value, "Total Stops<br>(Model Region)</br>", icon = "fa-map-marker")
```

Column {data-width=400, .tabset}
--------------------------------------------

### First Stop Arrival Time by Vehicle Type

```{r Chart_Commercial_Arrival_Time_By_Vehicle}
# Organize
cv_trips[Scheduled == 1L, MinTripID := min(TripID), by = .(BusID, Vehicle, TourID)]
dat <- cv_trips[TripID == MinTripID, .(Tours = .N), keyby = .(ArrivalTime = factor(floor(as.numeric(MAMArrive)/60)), Vehicle)]
dat[, PctTours := Tours/sum(Tours), by = Vehicle]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "CVTM_Stops_First_Stop_Arrival_Time_Vehicle.csv"), row.names = FALSE)
assign("db_tab_cv_stop_arrival_vehicle", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "ArrivalTime", yvar = "PctTours", xlabel = "Arrival Time at First Stop", ylabel = "Percent of Tours", fill = "Vehicle", position = "dodge")

```

### First Stop Arrival Time by Activity

```{r Chart_Commercial_Arrival_Time_By_Activity}
# Organize
dat <- cv_trips[TripID == MinTripID, .(Tours = .N), keyby = .(ArrivalTime = factor(floor(as.numeric(MAMArrive)/60)), Activity)]
dat[, PctTours := Tours/sum(Tours), by = Activity]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "CVTM_Stops_First_Stop_Arrival_Time_Activity.csv"), row.names = FALSE)
assign("db_tab_cv_stop_arrival_activity", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "ArrivalTime", yvar = "PctTours", xlabel = "Arrival Time at First Stop", ylabel = "Percent of Tours", fill = "Activity", position = "dodge")

```

### Stop Duration by Vehicle Type

```{r Chart_Commercial_Stop_Duration_By_Vehicle}
# Organize
dur_bins <- c(seq(0,120, 15), seq(180,360,60))

dat <- cv_trips[Activity != "Return", .(Vehicle, StopDuration)]
dat[, StopDurationBin := dur_bins[findInterval(StopDuration, dur_bins)]]
dat <- dat[, .(Stops = .N), keyby = .(StopDurationBin, Vehicle)]
dat[, StopDurationBin := factor(StopDurationBin)]
dat[, PctStops := Stops/sum(Stops), by = Vehicle]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "CVTM_Stops_Duration_Vehicle.csv"), row.names = FALSE)
assign("db_tab_cv_stop_duration_vehicle", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "StopDurationBin", yvar = "PctStops", xlabel = "Stop Duration (minutes, lower bound)", ylabel = "Percent of Stops", fill = "Vehicle", position = "dodge")

```

### Stop Duration by Activity (Scheduled)

```{r Chart_Commercial_Stop_Duration_By_Activity_Scheduled}
# Organize
dur_bins <- c(seq(0,120, 15), seq(180,360,60))

dat <- cv_trips[Activity != "Return" & Scheduled == 1L, .(Activity, StopDuration)]
dat[, StopDurationBin := dur_bins[findInterval(StopDuration, dur_bins)]]
dat <- dat[, .(Stops = .N), keyby = .(StopDurationBin, Activity)]
dat[, StopDurationBin := factor(StopDurationBin)]
dat[, PctStops := Stops/sum(Stops), by = Activity]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "CVTM_Stops_Duration_Activity_Scheduled.csv"), row.names = FALSE)
assign("db_tab_cv_stop_duration_activity_scheduled", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "StopDurationBin", yvar = "PctStops", xlabel = "Stop Duration (minutes, lower bound)", ylabel = "Percent of Stops", fill = "Activity", position = "dodge")

```

### Stop Duration by Activity (Non-Scheduled)

```{r Chart_Commercial_Stop_Duration_By_Activity_Non-Scheduled}
# Organize
dur_bins <- c(seq(0,120, 15), seq(180,360,60))

dat <- cv_trips[Activity != "Return" & Scheduled == 0L, .(Activity, StopDuration)]
dat[, StopDurationBin := dur_bins[findInterval(StopDuration, dur_bins)]]
dat <- dat[, .(Stops = .N), keyby = .(StopDurationBin, Activity)]
dat[, StopDurationBin := factor(StopDurationBin)]
dat[, PctStops := Stops/sum(Stops), by = Activity]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "CVTM_Stops_Duration_Activity_Non-Scheduled.csv"), row.names = FALSE)
assign("db_tab_cv_stop_duration_activity_nonsched", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "StopDurationBin", yvar = "PctStops", xlabel = "Stop Duration (minutes, lower bound)", ylabel = "Percent of Stops", fill = "Activity", position = "dodge")

```

Column {data-width=400, .tabset}
--------------------------------------------

### First Stop Arrival Time by Vehicle Type and Activty

```{r Table_Commercial_Arrival_Time_By_Vehicle_Activity}

# Organize
cv_trips[Scheduled == 1L, MinTripID := min(TripID), by = .(BusID, Vehicle, TourID)]
dat <- cv_trips[TripID == MinTripID, .(Tours = .N), keyby = .(ArrivalTime = factor(floor(as.numeric(MAMArrive)/60)), Vehicle, Activity)]

dat <- add_totals(dcast.data.table(dat,
                                  ArrivalTime ~ Vehicle + Activity,
                                   fun.aggregate = sum,
                                   value.var = "Tours"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "CVTM_Stops_First_Stop_Arrival_Time_Vehicle_Activity.csv"), row.names = FALSE)
assign("db_tab_cv_stop_arrival_vehicle_activity", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Stop Duration by Vehicle and Activity (Scheduled)

```{r Chart_Commercial_Stop_Duration_By_Vehicle_Activity}
# Organize
dur_bins <- c(seq(0,120, 15), seq(180,360,60))

dat <- cv_trips[Activity != "Return", .(Vehicle, Activity, StopDuration)]
dat[, StopDurationBin := dur_bins[findInterval(StopDuration, dur_bins)]]
dat <- dat[, .(Stops = .N), keyby = .(StopDurationBin, Vehicle, Activity)]
dat[, StopDurationBin := factor(StopDurationBin)]

dat <- add_totals(dcast.data.table(dat,
                                  StopDurationBin ~ Vehicle + Activity,
                                   fun.aggregate = sum,
                                   value.var = "Stops"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "CVTM_Stops_Duration_Vehicle_Activity.csv"), row.names = FALSE)
assign("db_tab_cv_stop_duration_vehicle_activity", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

Tours {data-navmenu="Commercial Vehicle Touring Model"}
============================================

Highlights {data-width=150}
--------------------------------------------

**Commercial Vehicle Touring Model: Tours**

Commercial vehicle tours by location, activity, and length

### Light Vehicle Tours (Model Region)

```{r Commercial_Vehicle_Tours_Light_ValueBox2}

value <- format(cv_trips[Vehicle == "Light", uniqueN(TourID)],
                big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Light Vehicle Tours (Model Region)", icon = "fa-truck")

```

### Medium Truck Tours (Model Region)

```{r Commercial_Vehicle_Tours_Medium_ValueBox2}

value <- format(cv_trips[Vehicle == "Medium", uniqueN(TourID)],
                big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Medium Truck Tours (Model Region)", icon = "fa-truck")

```

### Heavy Truck Tours (Model Region)

```{r Commercial_Vehicle_Tours_Heavy_ValueBox2}

value <- format(cv_trips[Vehicle == "Heavy", uniqueN(TourID)],
                big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Heavy Truck Tours (Model Region)", icon = "fa-truck")

```

### Total Tours (Stops in CMAP MPO)

```{r Commercial_Vehicle_Tours_ValueBox2_CMAP}

value <- format(cv_trips[OTAZ %in% BASE_TAZ_CMAP | DTAZ %in% BASE_TAZ_CMAP, uniqueN(TourID)],
                big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Commercial Vehicle Tours (Stop in CMAP MPO Area)", icon = "fa-truck")

```

### Total Tours (Stops in Rest of Region)

```{r Commercial_Vehicle_Tours_ValueBox2_NonCMAP}

value <- format(cv_trips[!OTAZ %in% BASE_TAZ_CMAP | !DTAZ %in% BASE_TAZ_CMAP, uniqueN(TourID)],
                big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Commercial Vehicle Tours (Stop in Rest of Region)", icon = "fa-truck")

```

### Total Tours (Model Region)

```{r Commercial_Vehicle_Tours_ValueBox2}

value <- format(cv_trips[, uniqueN(TourID)],
                big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Commercial Vehicle Tours (Model Region)", icon = "fa-truck")

```

Column {data-width=400, .tabset}
--------------------------------------------

### Tour Start Locations by District

```{r Chart_Commercial_Tour_Starts_by_District}
# Organize
dat <- cv_trips[TripID == 1, .(Region = Region.Start, Vehicle)]
dat[, Region := factor(Region, levels = sort_levels(Region))]
dat <- dat[,.N, by = .(Region, Vehicle)][order(Region)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Tour_Start_Locations_by_District.csv"), row.names = FALSE)
assign("db_tab_cv_tour_start_district", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Region", yvar = "N", fill = "Vehicle", xlabel = "Tour Start District", ylabel = "Commercial Vehicle Tours", coord_flip = TRUE)
```

> Includes all CV tours in the model region

### Total Stops per Tour by Vehicle

```{r Chart_Commercial_Stops_per_Tour_By_Vehicle}
# Organize
dat <- cv_trips[, .(Stops = .N), by = .(TourID, Vehicle)]
dat <- dat[, .(Tours = .N), keyby = .(Stops, Vehicle)]
dat[, PctTours := Tours/sum(Tours), keyby = Vehicle]
dat[, Stops := factor(Stops)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Tour_Stops_Tours.csv"), row.names = FALSE)
assign("db_tab_cv_tour_stops_tours", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Stops", yvar = "PctTours", fill = "Vehicle", position = "dodge", xlabel = "Number of Stops per Tour", ylabel = "Percent Commercial Vehicle Tours", coord_flip = TRUE)
```

> Total Stops includes all Stops on the Tour for Scheduled and Non-Scheduled Activities, as well as the Return Stop at the end of the Tour

### Scheduled Stops per Tour by Vehicle

```{r Chart_Commercial_Scheduled_Stops_per_Tour_By_Vehicle}
# Organize
dat <- cv_trips[Scheduled == 1L & Activity != "Return", .(Stops = .N), by = .(TourID, Vehicle)]
dat <- dat[, .(Tours = .N), keyby = .(Stops, Vehicle)]
dat[, PctTours := Tours/sum(Tours), keyby = Vehicle]
dat[, Stops := factor(Stops)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Tour_Scheduled_Stops_Tours.csv"), row.names = FALSE)
assign("db_tab_cv_tour_sched_stops_tours", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Stops", yvar = "PctTours", fill = "Vehicle", position = "dodge", xlabel = "Number of Scheduled Stops per Tour", ylabel = "Percent Commercial Vehicle Tours", coord_flip = TRUE)
```

> Scheduled Stops includes all Stops on the Tour for Scheduled Activities, which are Goods Deliveries and Service Stops. The Return Stop at the end of the Tour is not included.

### Non-Scheduled Stops per Tour by Vehicle

```{r Chart_Commercial_NonSched_Stops_per_Tour_By_Vehicle}
# Organize
dat <- cv_trips[Scheduled == 0L & Activity != "Return", .(Stops = .N), by = .(TourID, Vehicle)]
dat <- merge(dat,
             cv_trips[, .(AllStops = .N), by = .(TourID, Vehicle)],
             by = c("TourID","Vehicle"),
             all = TRUE)
dat[is.na(Stops), Stops := 0]

dat <- dat[, .(Tours = .N), keyby = .(Stops, Vehicle)]
dat[, PctTours := Tours/sum(Tours), keyby = Vehicle]
dat[, Stops := factor(Stops)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Tour_NonScheduled_Stops_Tours.csv"), row.names = FALSE)
assign("db_tab_cv_tour_nonsched_stops_tours", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Stops", yvar = "PctTours", fill = "Vehicle", position = "dodge", xlabel = "Number of Non-Scheduled Stops per Tour", ylabel = "Percent Commercial Vehicle Tours", coord_flip = TRUE)
```

> Non-Scheduled Stops includes all Stops on the Tour for Non-Scheduled Activities, which are Driver Breaks and Vehicle Service Stops.

### Tour Length by Vehicle Type

```{r Density_Commercial_Tour_Length_By_Vehicle}
# Organize
dat <- cv_trips[, .(`Tour Length` = sum(Distance)), by = .(BusID, Vehicle, TourID)]

# Save
assign("db_tab_cv_tour_distance_vehicle", dat, envir = db_inputs)

# Plot
alpha <- 0.95
x.limits <- c(0, quantile(dat$`Tour Length`, alpha))
p <- ggplot(dat, aes(x = `Tour Length`, fill = Vehicle)) +
  geom_density(alpha = 0.25) + ylab("Density") + xlim(x.limits) +
  xlab(paste0("Tour Length (", BASE_DASHBOARD_LENGTH_UNIT, ")")) +
  theme_db

plotly_build(p)
```

>`r if(SCENARIO_RUN_CVTM) {paste0("Note: ", percent(1 - alpha), " of trips are longer than ", round(x.limits[2]), " minutes and are not displayed.")}`

### Tour Duration by Vehicle Type

```{r Density_Commercial_Tour_Duration_By_Vehicle}
# Organize
dat <- cv_trips[, .(`Tour Duration (mins)` = sum(TravelTime+StopDuration)),
                by = .(BusID, Vehicle, TourID)]

# Save
assign("db_tab_cv_tour_duration_vehicle", dat, envir = db_inputs)

# Plot
alpha <- 0.95
x.limits <- c(0, quantile(dat$`Tour Duration (mins)`, alpha))
p <- ggplot(dat, aes(x = `Tour Duration (mins)`, fill = Vehicle)) +
  geom_density(alpha = 0.25) + ylab("Density") + xlim(x.limits) +
  theme_db

plotly_build(p)
```

>`r if(SCENARIO_RUN_CVTM) {paste0("Note: ", percent(1 - alpha), " of trips are longer than ", round(x.limits[2]), " minutes and are not displayed.")}`

### Tour Length Cumulative Distributions

```{r CumDist_Commercial_Tour_Length_By_Vehicle}
# Organize
dat <- cv_trips[, .(TourLength = sum(Distance)), by = .(BusID, Vehicle, TourID)]
dat[, TourLengthRnd := round(TourLength,-1)]
dat <- dat[,.(Tours = .N), keyby = .(TourLengthRnd, Vehicle)]
dat[, ToursCum := cumsum(Tours), by = Vehicle]
dat[, PctTours := Tours/sum(Tours), by = Vehicle]
dat[, PctToursCum := cumsum(PctTours), by = Vehicle]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Tour_CumDist_Vehicle.csv"), row.names = FALSE)
assign("db_tab_cv_tour_cumdist_tours", dat, envir = db_inputs)

# Plot
bar_plotter(dat[TourLengthRnd <= 200], xvar = "TourLengthRnd", yvar = "PctToursCum", fill = "Vehicle", position = "dodge", xlabel = "Tour Length", ylabel = "Cumulative Percent CV Tours")


```


Column {data-width=400, .tabset}
--------------------------------------------

### Stops by Number of Tour Stops and Stop Activity

```{r Table_Commercial_Tours_by_Stops_Activity}
# Organize
dat <- cv_trips[,.(Stops = .N), keyby = .(TourID, Activity)]

dat <- merge(dat,
             cv_trips[, .(TourStops = .N), by = .(TourID)],
             by = c("TourID"),
             all = TRUE)
dat[is.na(Stops), Stops := 0]
dat[, TourStops := factor(TourStops)]

dat <- add_totals(dcast.data.table(dat,
                                  TourStops ~ Activity,
                                   fun.aggregate = sum,
                                   value.var = "Stops"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Stop_Activity_Tour_Composition.csv"), row.names = FALSE)
assign("db_tab_cv_tour_activity_composition", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

> Table includes a count of stops by activity for tours with different numbers of total stops

### Light Vehicle Stops by Number of Tour Stops and Stop Activity

```{r Table_Light_Vehicle_Tours_by_Stops_Activity}
# Organize
dat <- cv_trips[Vehicle == "Light",.(Stops = .N), keyby = .(TourID, Activity)]

dat <- merge(dat,
             cv_trips[Vehicle == "Light", .(TourStops = .N), by = .(TourID)],
             by = c("TourID"),
             all = TRUE)
dat[is.na(Stops), Stops := 0]
dat[, TourStops := factor(TourStops)]

dat <- add_totals(dcast.data.table(dat,
                                  TourStops ~ Activity,
                                   fun.aggregate = sum,
                                   value.var = "Stops"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Light_Stop_Activity_Tour_Composition.csv"), row.names = FALSE)
assign("db_tab_cv_tour_activity_composition_light", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

> Table includes a count of stops by activity for tours with different numbers of total stops

### Medium Truck Stops by Number of Tour Stops and Stop Activity

```{r Table_Medium_Truck_Tours_by_Stops_Activity}
# Organize
dat <- cv_trips[Vehicle == "Medium",.(Stops = .N), keyby = .(TourID, Activity)]

dat <- merge(dat,
             cv_trips[Vehicle == "Medium", .(TourStops = .N), by = .(TourID)],
             by = c("TourID"),
             all = TRUE)
dat[is.na(Stops), Stops := 0]
dat[, TourStops := factor(TourStops)]

dat <- add_totals(dcast.data.table(dat,
                                  TourStops ~ Activity,
                                   fun.aggregate = sum,
                                   value.var = "Stops"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Medium_Stop_Activity_Tour_Composition.csv"), row.names = FALSE)
assign("db_tab_cv_tour_activity_composition_medium", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

> Table includes a count of stops by activity for tours with different numbers of total stops

### Heavy Truck Stops by Number of Tour Stops and Stop Activity

```{r Table_Heavy_Truck_Tours_by_Stops_Activity}
# Organize
dat <- cv_trips[Vehicle == "Heavy",.(Stops = .N), keyby = .(TourID, Activity)]

dat <- merge(dat,
             cv_trips[Vehicle == "Heavy", .(TourStops = .N), by = .(TourID)],
             by = c("TourID"),
             all = TRUE)
dat[is.na(Stops), Stops := 0]
dat[, TourStops := factor(TourStops)]

dat <- add_totals(dcast.data.table(dat,
                                  TourStops ~ Activity,
                                   fun.aggregate = sum,
                                   value.var = "Stops"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Heavy_Stop_Activity_Tour_Composition.csv"), row.names = FALSE)
assign("db_tab_cv_tour_activity_composition_heavy", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

> Table includes a count of stops by activity for tours with different numbers of total stops

Trips {data-navmenu="Commercial Vehicle Touring Model"}
============================================

Highlights {data-width=150}
--------------------------------------------

**Commercial Vehicle Touring Model: Trips**

Commercial vehicle trips by location, activity, and length

### Light Vehicle Daily Trips (Model Region)

```{r Daily_Light_CV_Trips_ValueBox}
value <- format(cv_trips[Vehicle == "Light", .N], big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Daily Trips by Light Vehicle", icon = "fa-arrow-down")
```

### Medium Truck Daily Trips (Model Region)

```{r Daily_Medium_CV_Trips_ValueBox}
value <- format(cv_trips[Vehicle == "Medium", .N], big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Daily Trips by Medium Trucks", icon = "fa-arrow-down")
```

### Heavy Truck Daily Trips (Model Region)

```{r Daily_Heavy_CV_Trips_ValueBox}
value <- format(cv_trips[Vehicle == "Heavy", .N], big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Daily Trips by Heavy Trucks", icon = "fa-arrow-down")
```

### CMAP Daily Trips

```{r Daily_CMAP_CV_Trips_ValueBox}
value <- format(cv_trips[OTAZ %in% BASE_TAZ_CMAP|DTAZ %in% BASE_TAZ_CMAP, .N], big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Daily Trips (CMAP MPO Area)", icon = "fa-arrow-down")
```

### Daily Trips Rest of Region

```{r Daily_NonCMAP_CV_Trips_ValueBox}
value <- format(cv_trips[!OTAZ %in% BASE_TAZ_CMAP | !DTAZ %in% BASE_TAZ_CMAP, .N], big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Daily Trips (Rest of Region)", icon = "fa-arrow-down")
```

### Total Daily Trips

```{r Daily_Trips_CV_ValueBox}
value <- format(cv_trips[, .N], big.mark = ",", digits = 0, scientific = FALSE, trim = TRUE)
valueBox(value, caption = "Total Daily CV Trips", icon = "fa-arrow-down")
```

Column {data-width=400, .tabset}
--------------------------------------------

### Trips by Time Period

```{r Chart_Commercial_Trips_TOD_Vehicle}
# Organize
dat <- cv_trips[,.N, keyby = .(TOD, Vehicle)]
dat[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Trip_TOD_Vehicle.csv"), row.names = FALSE)
assign("db_tab_cv_trip_tod_vehicle", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "TOD", yvar = "N", fill = "Vehicle", xlabel = "Time Period", ylabel = "Commercial Vehicle Trips", position = "dodge")
```

### Trip Origins by District

```{r Chart_Commercial_Trips_Origins_by_District}
# Organize
dat <- cv_trips[, .(Region = Region.Origin, Vehicle)]
dat[, Region := factor(Region, levels = sort_levels(Region))]
dat <- dat[,.N, by = .(Region, Vehicle)][order(Region)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Trip_Origins_by_District.csv"), row.names = FALSE)
assign("db_tab_cv_trip_origin_district", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Region", yvar = "N", fill = "Vehicle", xlabel = "Trip Origin District", ylabel = "Commercial Vehicle Trips", coord_flip = TRUE)
```

### Trip Destinations by District

```{r Chart_Commercial_Trips_Destinations_by_Region}
# Organize
dat <- cv_trips[, .(Region = Region.Destination, Vehicle)]
dat[, Region := factor(Region, levels = sort_levels(Region))]
dat <- dat[,.N, by = .(Region, Vehicle)][order(Region)]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_Trip_Destinations_by_District.csv"), row.names = FALSE)
assign("db_tab_cv_trip_destination_district", dat, envir = db_inputs)

# Plot
bar_plotter(dat, xvar = "Region", yvar = "N", fill = "Vehicle", xlabel = "Trip Destination District", ylabel = "Commercial Vehicle Trips", coord_flip = TRUE)
```

### Trip Length by Vehicle Type

```{r Density_Commercial_Trip_Length_By_Vehicle}
# Organize
dat <- cv_trips[, .(Vehicle, `Trip Length` = Distance)]

# Save
assign("db_tab_cv_trip_distance_vehicle", dat, envir = db_inputs)

# Plot
alpha <- 0.95
x.limits <- c(0, quantile(dat$`Trip Length`, alpha))
p <- ggplot(dat, aes(x = `Trip Length`, fill = Vehicle)) +
  geom_density(alpha = 0.25) + ylab("Density") + xlim(x.limits) +
  xlab(paste0("Trip Length (", BASE_DASHBOARD_LENGTH_UNIT, ")")) +
  theme_db
plotly_build(p)
```

>`r if(SCENARIO_RUN_CVTM) {paste0("Note: ", percent(1 - alpha), " of trips are longer than ", round(x.limits[2]), " minutes and are not displayed.")}`


### Trip Duration by Vehicle Type

```{r Density_Commercial_Trip_Duration_By_Vehicle}
# Organize
dat <- cv_trips[, .(Vehicle, `Trip Duration (mins)` = TravelTime)]

# Save
assign("db_tab_cv_trip_duration_vehicle", dat, envir = db_inputs)

# Plot
alpha <- 0.95
x.limits <- c(0, quantile(dat$`Trip Duration (mins)`, alpha))
p <- ggplot(dat, aes(x = `Trip Duration (mins)`, fill = Vehicle)) +
  geom_density(alpha = 0.25) + ylab("Density") + xlim(x.limits) +
  theme_db
plotly_build(p)
```

>`r if(SCENARIO_RUN_CVTM) {paste0("Note: ", percent(1 - alpha), " of trips are longer than ", round(x.limits[2]), " minutes and are not displayed.")}`

Column {data-width=400, .tabset}
--------------------------------------------

### Total Trip Origins by District and TOD

```{r Table_District_TOD_AllVehicle}
# Organize
dat <- cv_trips[,.(Vehicle = "All Vehicles", .N), keyby = .(District = Region.Origin, TOD)]
dat[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]

dat <- add_totals(dcast.data.table(dat,
                                  Vehicle + District ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "N"),
                  idcols = 2L)
dat[is.na(Vehicle), Vehicle := ""]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_District_TOD_AllVehicles.csv"), row.names = FALSE)
assign("db_tab_cv_district_tod_allvehicles", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Light Vehicle Trip Origins by District and TOD

```{r Table_District_TOD_LightVehicle}
# Organize
dat <- cv_trips[Vehicle == "Light",.(.N), keyby = .(District = Region.Origin, TOD, Vehicle)]
dat[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]

dat <- add_totals(dcast.data.table(dat,
                                  Vehicle + District ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "N"),
                  idcols = 2L)
dat[is.na(Vehicle), Vehicle := ""]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_District_TOD_Light.csv"), row.names = FALSE)
assign("db_tab_cv_district_tod_light", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Medium Truck Trip Origins by District and TOD

```{r Table_District_TOD_MediumVehicle}
# Organize
dat <- cv_trips[Vehicle == "Medium",.(.N), keyby = .(District = Region.Origin, TOD, Vehicle)]
dat[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]

dat <- add_totals(dcast.data.table(dat,
                                  Vehicle + District ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "N"),
                  idcols = 2L)
dat[is.na(Vehicle), Vehicle := ""]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_District_TOD_Medium.csv"), row.names = FALSE)
assign("db_tab_cv_district_tod_medium", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Heavy Truck Trip Origins by District and TOD

```{r Table_District_TOD_HeavyVehicle}
# Organize
dat <- cv_trips[Vehicle == "Heavy",.(.N), keyby = .(District = Region.Origin, TOD, Vehicle)]
dat[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]

dat <- add_totals(dcast.data.table(dat,
                                  Vehicle + District ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "N"),
                  idcols = 2L)
dat[is.na(Vehicle), Vehicle := ""]

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "Commercial_District_TOD_Heavy.csv"), row.names = FALSE)
assign("db_tab_cv_district_tod_heavy", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```



```{r section_build_cv_sim_cal, results='asis', eval=SCENARIO_DB_CALIBRATION}
section_cv_sim_cal <- knitr::knit_child('section_cv_sim_cal.Rmd',
                              envir = environment(),
                              quiet = TRUE)
cat(unlist(section_cv_sim_cal), sep = '\n')
```


```{r section_build_cv_sim_ref, results='asis', eval=SCENARIO_DB_REFERENCE}
section_cv_sim_ref <- knitr::knit_child('section_cv_sim_ref.Rmd',
                              envir = environment(),
                              quiet = TRUE)
cat(unlist(section_cv_sim_ref), sep = '\n')
```


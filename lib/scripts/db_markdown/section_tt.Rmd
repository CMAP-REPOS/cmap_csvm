---
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
    css: "ReportDashboardStyles.css"
editor_options: 
  chunk_output_type: console
---
Daily Trips {data-navmenu="Trip Tables"}
============================================

Highlights {data-width=150}
--------------------------------------------

**Trip Tables: Daily Trips**

Daily trip tables combining trips from the commercial services vehicle model for the CMAP model.

### Trips within CMAP Model Region

```{r Trip_Table_Total_Trips_ValueBox}
value <- format(sum(tmh_vtods$Trips, na.rm = TRUE), 
                digits = 0, big.mark = ",", scientific = FALSE, trim = TRUE)
valueBox(value, "Total Trips<br>(Model Region)</br>", icon = "fa-map-marker")
```

### Total VMT in CMAP Model Region

```{r Trip_Table_Total_VMT_ValueBox2}
value <- format(sum(tmh_vtods$VMT, na.rm = TRUE), 
                digits = 0, big.mark = ",", scientific = FALSE, trim = TRUE)
valueBox(value, "Total VMT<br>(Model Region)</br>", icon = "fa-map-marker")
```

### Total VHT in CMAP Model Region

```{r Trip_Table_Total_VHT_ValueBox2}
value <- format(sum(tmh_vtods$VHT, na.rm = TRUE), 
                digits = 0, big.mark = ",", scientific = FALSE, trim = TRUE)
valueBox(value, "Total VHT<br>(Model Region)</br>", icon = "fa-map-marker")
```

### Mean Trip Distance in CMAP Model Region

```{r Trip_Table_Av_Dist_ValueBox2}
value <- format(sum(tmh_vtods$VMT, na.rm = TRUE)/sum(tmh_vtods$Trips, na.rm = TRUE), 
                digits = 0, big.mark = ",", scientific = FALSE, trim = TRUE)
valueBox(value, "Mean Trip Distance (Miles)<br>(Model Region)</br>", icon = "fa-map-marker")
```

### Mean Trip Travel Time in CMAP Model Region

```{r Trip_Table_Av_Time_ValueBox2}
value <- format(sum(tmh_vtods$VHT, na.rm = TRUE)/sum(tmh_vtods$Trips, na.rm = TRUE) * 60, 
                digits = 0, big.mark = ",", scientific = FALSE, trim = TRUE)
valueBox(value, "Mean Trip Travel Time (Minutes)<br>(Model Region)</br>", icon = "fa-map-marker")
```


Column {data-width=600, .tabset}
--------------------------------------------

### Total Trips by Vehicle and TOD, VMT, and VHT 

```{r Chart_Total_Trips_By_Vehicle_Segment_TOD}
# Organize

dat_vt <- TripTable[, .(Trips = sum(trips, na.rm = TRUE), Measure = "Trips"), keyby = .(Vehicle, TOD)]
dat_vt[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]

dat_vt <- add_totals(dcast.data.table(dat_vt,
                                  Vehicle + Measure ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "Trips"),
                      idcols = 2L, coltotal = FALSE)

dat_vtt <- TripTable[, .(Trips = sum(trips, na.rm = TRUE), Measure = "Trips", Vehicle = "All CVs (L+M+H)"), keyby = .(TOD)]
dat_vtt[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]
dat_vtt <- add_totals(dcast.data.table(dat_vtt,
                                  Vehicle + Measure ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "Trips"),
                      idcols = 2L, coltotal = FALSE)

dat_vm <- TripTable[, .(VMT = sum(VMT, na.rm = TRUE), Measure = "VMT"), keyby = .(Vehicle, TOD)]
dat_vm[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]
dat_vm <- add_totals(dcast.data.table(dat_vm,
                                  Vehicle + Measure ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "VMT"),
                      idcols = 2L, coltotal = FALSE)

dat_vmt <- TripTable[, .(VMT = sum(VMT, na.rm = TRUE), Measure = "VMT", Vehicle = "All CVs (L+M+H)"), keyby = .(TOD)]
dat_vmt[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]
dat_vmt <- add_totals(dcast.data.table(dat_vmt,
                                  Vehicle + Measure ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "VMT"),
                      idcols = 2L, coltotal = FALSE)

dat_vh <- TripTable[, .(VHT = sum(VHT, na.rm = TRUE), Measure = "VHT"), keyby = .(Vehicle, TOD)]
dat_vh[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]
dat_vh <- add_totals(dcast.data.table(dat_vh,
                                  Vehicle + Measure ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "VHT"),
                      idcols = 2L, coltotal = FALSE)

dat_vht <- TripTable[, .(VHT = sum(VHT, na.rm = TRUE), Measure = "VHT", Vehicle = "All CVs (L+M+H)"), keyby = .(TOD)]
dat_vht[, TOD := factor(TOD, levels = names(BASE_TOD_RANGES))]
dat_vht <- add_totals(dcast.data.table(dat_vht,
                                  Vehicle + Measure ~ TOD,
                                   fun.aggregate = sum,
                                   value.var = "VHT"),
                      idcols = 2L, coltotal = FALSE)

dat <- rbind(dat_vt, dat_vm, dat_vh, dat_vtt, dat_vmt, dat_vht)


# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_Trips_VMT_VHT_by_Vehicle_Segment_TOD.csv"))
assign("db_tab_tt_trips_vmt_vht_veh_tod", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 0) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec((nrow(dat)-2):nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Total Trips by District OD 

```{r Chart_Total_Trips_By_District_OD}
# Organize
dat <- TripTable[, .(Trips = sum(trips, na.rm = TRUE)), by = .(OriginDistrict = OSummaryGeog, DestinationDistrict = DSummaryGeog)]
dat <- add_totals(dcast.data.table(dat,
                                  OriginDistrict ~ DestinationDistrict,
                                   fun.aggregate = sum,
                                   value.var = "Trips"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_Trips_by_District_OD.csv"))
assign("db_tab_tt_trips_district_od", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 0) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Light Vehice Trips by District OD 

```{r Chart_Light_Trips_By_District_OD}
# Organize
dat <- TripTable[Vehicle == "Light", .(Trips = sum(trips, na.rm = TRUE)), by = .(OriginDistrict = OSummaryGeog, DestinationDistrict = DSummaryGeog)]
dat <- add_totals(dcast.data.table(dat,
                                  OriginDistrict ~ DestinationDistrict,
                                   fun.aggregate = sum,
                                   value.var = "Trips"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_Light_Trips_by_District_OD.csv"))
assign("db_tab_tt_trips_district_od_light", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 0) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Medium Truck Trips by District OD 

```{r Chart_Medium_Trips_By_District_OD}
# Organize
dat <- TripTable[Vehicle == "Medium", .(Trips = sum(trips, na.rm = TRUE)), by = .(OriginDistrict = OSummaryGeog, DestinationDistrict = DSummaryGeog)]
dat <- add_totals(dcast.data.table(dat,
                                  OriginDistrict ~ DestinationDistrict,
                                   fun.aggregate = sum,
                                   value.var = "Trips"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_Medium_Trips_by_District_OD.csv"))
assign("db_tab_tt_trips_district_od_medium", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 0) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Heavy Truck Trips by District OD 

```{r Chart_Heavy_Trips_By_District_OD}
# Organize
dat <- TripTable[Vehicle == "Heavy", .(Trips = sum(trips, na.rm = TRUE)), by = .(OriginDistrict = OSummaryGeog, DestinationDistrict = DSummaryGeog)]
dat <- add_totals(dcast.data.table(dat,
                                  OriginDistrict ~ DestinationDistrict,
                                   fun.aggregate = sum,
                                   value.var = "Trips"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_Heavy_Trips_by_District_OD.csv"))
assign("db_tab_tt_trips_district_od_heavy", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 0) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")
```

### Percent Trips by District OD 

```{r Chart_Percent_Trips_By_District_OD}
# Organize
dat <- TripTable[, .(Trips = sum(trips, na.rm = TRUE)), by = .(OriginDistrict = OSummaryGeog, DestinationDistrict = DSummaryGeog)]
dat[, PctTrips := Trips/sum(Trips)]
dat <- add_totals(dcast.data.table(dat,
                                  OriginDistrict ~ DestinationDistrict,
                                   fun.aggregate = sum,
                                   value.var = "PctTrips"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_PctTrips_by_District_OD.csv"))
assign("db_tab_tt_pcttrips_district_od", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Light Vehice Percent Trips by District OD 

```{r Chart_Light_PctTrips_By_District_OD}
# Organize
dat <- TripTable[Vehicle == "Light", .(Trips = sum(trips, na.rm = TRUE)), by = .(OriginDistrict = OSummaryGeog, DestinationDistrict = DSummaryGeog)]
dat[, PctTrips := Trips/sum(Trips)]
dat <- add_totals(dcast.data.table(dat,
                                  OriginDistrict ~ DestinationDistrict,
                                   fun.aggregate = sum,
                                   value.var = "PctTrips"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_Light_PctTrips_by_District_OD.csv"))
assign("db_tab_tt_pcttrips_district_od_light", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Medium Truck Percent Trips by District OD 

```{r Chart_Medium_PctTrips_By_District_OD}
# Organize
dat <- TripTable[Vehicle == "Medium", .(Trips = sum(trips, na.rm = TRUE)), by = .(OriginDistrict = OSummaryGeog, DestinationDistrict = DSummaryGeog)]
dat[, PctTrips := Trips/sum(Trips)]
dat <- add_totals(dcast.data.table(dat,
                                  OriginDistrict ~ DestinationDistrict,
                                   fun.aggregate = sum,
                                   value.var = "PctTrips"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_Medium_PctTrips_by_District_OD.csv"))
assign("db_tab_tt_pcttrips_district_od_medium", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")

```

### Heavy Truck Percent Trips by District OD 

```{r Chart_Heavy_PctTrips_By_District_OD}
# Organize
dat <- TripTable[Vehicle == "Heavy", .(Trips = sum(trips, na.rm = TRUE)), by = .(OriginDistrict = OSummaryGeog, DestinationDistrict = DSummaryGeog)]
dat[, PctTrips := Trips/sum(Trips)]
dat <- add_totals(dcast.data.table(dat,
                                  OriginDistrict ~ DestinationDistrict,
                                   fun.aggregate = sum,
                                   value.var = "PctTrips"))

# Save
fwrite(dat, file = file.path(SCENARIO_OUTPUT_PATH, "TripTable_Heavy_PctTrips_by_District_OD.csv"))
assign("db_tab_tt_pcttrips_district_od_heavy", dat, envir = db_inputs)

# Table
kable(dat, escape=FALSE, digits = 3) %>%
  kable_styling(fixed_thead = TRUE, bootstrap_options = c("condensed")) %>%
  row_spec(nrow(dat), background = "#f2f2f2") %>%
  column_spec(ncol(dat), background = "#f2f2f2")
```

```{r section_build_tt_cal, results='asis', eval=SCENARIO_DB_CALIBRATION}
section_tt_cal <- knitr::knit_child('section_tt_cal.Rmd',
                              envir = environment(),
                              quiet = TRUE)
cat(unlist(section_tt_cal), sep = '\n')
```

```{r section_build_tt_ref, results='asis', eval=SCENARIO_DB_REFERENCE}
section_tt_ref <- knitr::knit_child('section_tt_ref.Rmd',
                              envir = environment(),
                              quiet = TRUE)
cat(unlist(section_tt_ref), sep = '\n')
```
